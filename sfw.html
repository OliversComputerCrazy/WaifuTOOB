<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PurrBot Slideshow (Skip Missing)</title>
<style>
  html, body {
    margin: 0; padding: 0; height: 100%;
    background: #000; color: #fff;
    font-family: sans-serif;
    display: flex; align-items: center; justify-content: center;
  }
  #input-screen, #slideshow {
    position: absolute; inset: 0;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
  }
  #slideshow { display: none; background: #000; }
  #category {
    padding: 10px; font-size: 1.2em; border: none; border-radius: 6px;
    text-align: center; outline: none;
  }
  #go {
    margin-top: 10px; padding: 10px 20px;
    font-size: 1em; border: none; border-radius: 6px;
    cursor: pointer; background: #2b8cff; color: white;
  }
  img {
    max-width: 100vw;
    max-height: 100vh;
    object-fit: contain;
    transition: opacity 0.3s ease-in-out;
    opacity: 1;
  }
  #loading { font-size: 1.5em; margin-bottom: 10px; }
</style>
</head>
<body>

<div id="input-screen">
  <h1>PurrBot GIF Slideshow</h1>
  <input id="category" placeholder="Enter SFW category (e.g. hug)" list="categories" />
  <datalist id="categories"></datalist>
  <button id="go">Go!</button>
  <p>Swipe up/down or use ↑/↓ to navigate once slideshow starts.</p>
</div>

<div id="slideshow">
  <div id="loading">Loading...</div>
  <img id="gif" style="display:none;">
</div>

<script>
const inputScreen = document.getElementById("input-screen");
const slideshow = document.getElementById("slideshow");
const img = document.getElementById("gif");
const loading = document.getElementById("loading");
const goBtn = document.getElementById("go");
const catInput = document.getElementById("category");
const datalist = document.getElementById("categories");

// --- Categories array ---
const categories = ["bite", "blush", "comfy", "cry", "cuddle", "dance", "fluff", "hug", "kiss", "lay", "lick", "pat", "poke", "pout", "slap", "smile", "tail", "tickle"];
categories.forEach(cat => {
  const option = document.createElement("option");
  option.value = cat;
  datalist.appendChild(option);
});

// --- Slideshow variables ---
let images = [];
let index = 1;        // current image being viewed
let lastFetched = 0;  // highest-numbered GIF attempted
let touchStartY = 0;
let nextImage = null; // preloaded next image
const maxAttempts = 50; // max consecutive missing GIFs before stopping

// --- Event listeners ---
goBtn.addEventListener("click", startSlideshow);
catInput.addEventListener("keypress", e => {
  if (e.key === "Enter") startSlideshow();
});

// --- Build GIF URL ---
function buildUrl(category, num) {
  return `https://cdn.purrbot.site/sfw/${category}/gif/${category}_${String(num).padStart(3,'0')}.gif`;
}

// --- Preload next valid image ---
function preloadNextImage() {
  const cat = catInput.value.trim().toLowerCase();
  let attempts = 0;

  const tryNext = () => {
    if (attempts >= maxAttempts) {
      console.log("Reached end after too many missing images.");
      nextImage = null;
      return;
    }

    const nextNum = lastFetched + 1;
    const url = buildUrl(cat, nextNum);
    console.log("Preloading next image:", url);

    nextImage = new Image();
    nextImage.onload = () => {
      lastFetched = nextNum;
      images.push(url);
      console.log("Preloaded next image:", url);
    };
    nextImage.onerror = () => {
      lastFetched = nextNum;
      attempts++;
      tryNext(); // skip missing GIF and try next
    };
    nextImage.src = url;
  };

  tryNext();
}

// --- Start slideshow ---
function startSlideshow() {
  const cat = catInput.value.trim().toLowerCase();
  if (!cat) return alert("Please enter a category!");

  inputScreen.style.display = "none";
  slideshow.style.display = "flex";
  loading.style.display = "block";
  img.style.display = "none";

  images = [];
  index = 1;
  lastFetched = 0;
  nextImage = null;

  const firstUrl = buildUrl(cat, 1);
  console.log("Trying to load first image:", firstUrl);
  const firstImg = new Image();
  firstImg.onload = () => {
    images.push(firstUrl);
    lastFetched = 1;
    loading.style.display = "none";
    img.style.display = "block";
    img.src = firstUrl;
    console.log("Loaded first image:", firstUrl);
    preloadNextImage();
  };
  firstImg.onerror = () => {
    console.log("Failed to load first image:", firstUrl);
    alert("No images found for this category.");
    resetToInput();
  };
  firstImg.src = firstUrl;
}

// --- Show current image ---
function showImage() {
  if (index <= images.length) {
    console.log("Displaying loaded image:", images[index - 1]);
    img.style.opacity = 0;
    setTimeout(() => {
      img.src = images[index - 1];
      img.style.opacity = 1;
    }, 50);
    if (!nextImage) preloadNextImage();
    return;
  }

  if (nextImage) {
    console.log("Displaying preloaded next image:", nextImage.src);
    img.style.opacity = 0;
    setTimeout(() => {
      img.src = nextImage.src;
      img.style.opacity = 1;
    }, 50);
    nextImage = null;
    preloadNextImage();
  } else {
    console.log("No more images available.");
    resetToInput();
  }
}

// --- Reset to input screen ---
function resetToInput() {
  slideshow.style.display = "none";
  inputScreen.style.display = "flex";
  img.style.display = "none";
  loading.style.display = "block";
  images = [];
  index = 1;
  lastFetched = 0;
  nextImage = null;
  console.log("Returned to category input screen.");
}

// --- Keyboard navigation ---
window.addEventListener("keydown", e => {
  if (!images.length) return;
  if (e.key === "ArrowUp") { index++; showImage(); }
  if (e.key === "ArrowDown") { index--; if(index<1)index=1; showImage(); }
});

// --- Touch navigation ---
window.addEventListener("touchstart", e => { touchStartY = e.changedTouches[0].screenY; });
window.addEventListener("touchend", e => {
  if (!images.length) return;
  const diff = e.changedTouches[0].screenY - touchStartY;
  if (Math.abs(diff) < 30) return;
  if (diff < 0) { index++; showImage(); }
  else { index--; if(index<1)index=1; showImage(); }
});
</script>

</body>
</html>